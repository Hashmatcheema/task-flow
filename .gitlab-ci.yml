stages:
  - build
  - test
  - quality
  - package
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

cache:
  paths:
    - .m2/repository/

# Build stage: Compile the application
build-job:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Building application..."
    - mvn clean compile -B
  artifacts:
    paths:
      - target/
    expire_in: 1 hour
  only:
    changes:
      - "src/**/*"
      - "pom.xml"

# Test stage: Run unit and integration tests
test-job:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Running tests..."
    - mvn test -B
    - echo "Test coverage report generated"
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    paths:
      - target/surefire-reports/
      - target/site/jacoco/
    reports:
      junit: target/surefire-reports/TEST-*.xml
    expire_in: 1 week
  only:
    changes:
      - "src/**/*"
      - "pom.xml"

# Quality stage: Code quality checks
quality-job:
  stage: quality
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Running code quality checks..."
    - mvn verify -B
    - echo "Code quality check completed"
  artifacts:
    paths:
      - target/site/jacoco/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: target/site/jacoco/jacoco.xml
    expire_in: 1 week
  allow_failure: true
  only:
    changes:
      - "src/**/*"
      - "pom.xml"

# Package stage: Build Docker image
package-job:
  stage: package
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image..."
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - echo "Pushing Docker image to GitLab Container Registry..."
    - docker push $CI_REGISTRY_IMAGE:latest
    - echo "Docker image built and pushed successfully"
  only:
    - main
    - develop
    - merge_requests
  when: on_success

# Deploy stage: Deploy to local environment
deploy-job:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Deploying application from GitLab Container Registry..."
    - docker pull $CI_REGISTRY_IMAGE:latest
    - docker tag $CI_REGISTRY_IMAGE:latest taskflow:latest
    - docker-compose up -d
    - echo "Waiting for application to start..."
    - sleep 10
    - docker-compose ps
    - echo "Checking application health..."
    - |
      for i in {1..30}; do
        if wget --quiet --tries=1 --spider http://localhost:8080/api/tasks; then
          echo "Application is healthy!"
          exit 0
        fi
        echo "Waiting for application... ($i/30)"
        sleep 2
      done
      echo "Application health check failed"
      exit 1
  environment:
    name: local
    url: http://localhost:8080
  only:
    - main
  when: manual
  dependencies:
    - package-job